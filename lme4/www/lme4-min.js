/*
 * Ext JS Library 3.0.0
 * Copyright(c) 2006-2009 Ext JS, LLC
 * licensing@extjs.com
 * http://www.extjs.com/license
 */
Ext.onReady(function(){var d;Ext.Ajax.on("beforerequest",function(){d=Ext.Msg.wait("contacting R server... please wait...","waiting...")});Ext.Ajax.on("requestcomplete",function(){d.hide()});Ext.Ajax.on("requestexception",function(){d.hide()});Ext.form.Field.prototype.msgTarget="side";Ext.QuickTips.init();var m=0;function K(){return Ext.getCmp("cardLayout").getLayout().activeItem}function n(){return false}function E(){if(!Ext.getCmp("modelList").anova){return false}anovaData=Ext.getCmp("modelList").anova;anovaGrid=new Ext.grid.GridPanel({enableHdMenu:false,border:false,store:{xtype:"jsonstore",root:"anova",fields:["Name","Df","AIC","BIC","logLik","Chisq","Chi Df","Pr(>Chisq)"],data:Ext.getCmp("modelList")},columns:[{width:70,header:"Name",dataIndex:"Name"},{width:70,header:"Df",dataIndex:"Df"},{width:70,header:"AIC",dataIndex:"AIC"},{width:70,header:"BIC",dataIndex:"BIC"},{width:70,header:"logLik",dataIndex:"logLik"},{width:70,header:"Chisq",dataIndex:"Chisq"},{width:70,header:"Chi Df",dataIndex:"Chi Df"},{width:70,header:"Pr(>Chisq)",dataIndex:"Pr(>Chisq)"}]});myWin=new Ext.Window({iconCls:"book",title:"Analysis of Variance",closable:true,layout:"fit",height:55+(24*anovaData.length),width:580,autoScroll:true,items:anovaGrid});myWin.show()}function C(){if(!F){F=new Ext.Window({closeAction:"hide",iconCls:"bib",title:"Citing lme4",closable:true,layout:"fit",height:400,width:700,autoScroll:false,items:{border:false,applyTo:"citeDiv"}})}F.show()}function L(){for(var N in K().targetGroups){G(N)}K().fixef.getStore().loadData({fixef:[{id:1,name:"Intercept",estimate:"",SE:"",assign:"0",factor:"Intercept"}]});K().fixef.predictors=new Array();K().fixef.predictors[0]="Intercept";K().fixef.getTopToolbar().get(3).disable();K().fixef.getTopToolbar().get(4).disable();K().targetGroups=new Object();K().totalRandomEffects=new Object();K().randomGroupCount=0}function e(){numRecords=K().fixef.getStore().getCount();for(var P=0;P<numRecords;P++){K().fixef.getStore().getAt(P).set("tvalue","");K().fixef.getStore().getAt(P).set("SE","");K().fixef.getStore().getAt(P).set("estimate","");K().fixef.getStore().getAt(P).commit()}K().fixef.getTopToolbar().get(3).disable();K().fixef.getTopToolbar().get(4).disable();var O=0;for(var N in K().targetGroups){for(var P=0;P<K().targetGroups[N].getStore().getCount();P++){K().targetGroups[N].getStore().getAt(P).set("variance","");K().targetGroups[N].getStore().getAt(P).set("sd","");K().targetGroups[N].getStore().getAt(P).commit()}K().targetGroups[N].getTopToolbar().get(3).disable();K().targetGroups[N].getTopToolbar().get(4).disable();K().targetGroups[N].getTopToolbar().get(5).disable();K().targetGroups[N].getTopToolbar().get(6).disable();O++}}function v(O,P){if(O.leaf){menu=new Ext.menu.Menu({items:[]});selectedNodes=Ext.getCmp("tree-panel").getSelectionModel().getSelectedNodes();selectedPredictors=new Array();if(selectedNodes.length>1){for(var N=0;N<selectedNodes.length;N++){thisPredictor=selectedNodes[N].id;selectedPredictors[N]=thisPredictor;menu.add({iconCls:"add",thisPredictor:thisPredictor,text:"Add Fixed Effect <b> "+thisPredictor+"</b>",handler:function(){w(this.thisPredictor);return false}})}menu.add("-");interactionTerm=selectedPredictors.join(":");menu.add({iconCls:"add",thisPredictor:interactionTerm,text:"Add Interaction Effect: <b> "+interactionTerm+"</b>",handler:function(){w(this.thisPredictor);return false}});menu.add("-");menu.add({iconCls:"folder-add",thisPredictor:interactionTerm,text:"New Random Effects Group: <b> "+interactionTerm+"</b>",handler:function(){s(this.thisPredictor)}})}else{menu.add({iconCls:"add",thisPredictor:O.text,text:"Add Fixed Effect <b> "+O.text+"</b>",handler:function(){w(this.thisPredictor)}});menu.add("-");menu.add({iconCls:"folder-add",thisPredictor:O.text,text:"New Random Effects Group: <b> "+O.text+"</b>",handler:function(){s(this.thisPredictor)}})}P.stopEvent();menu.showAt(P.getPoint())}}removeFixed=function(N){e();predictor2remove=N.text;K().fixef.predictors.remove(predictor2remove);while(K().fixef.getStore().find("factor",predictor2remove)>-1){removeMe=K().fixef.getStore().find("factor",predictor2remove);K().fixef.getStore().removeAt(removeMe)}};function b(){m++;populateMenu=function(Q){menu2populate=Q.items.get(0).menu;menu2populate.removeAll();predictors=K().fixef.predictors;for(var P=0;P<predictors.length;P++){menu2populate.add({iconCls:"delete",text:predictors[P],handler:function(){removeFixed(this);populateMenu(Q);return false}})}};var N={listeners:{beforeshow:function(){populateMenu(this)}},xtype:"menu",id:"fixedMenu",items:[{text:"Remove Predictor",iconCls:"delete",menu:{id:"fixefRemoveMenu"}}]};var O=new Ext.grid.GridPanel({enableHdMenu:false,anchor:"100%",id:"fixedEffects_"+m,bodyStyle:"margin-bottom:10px;",store:new Ext.data.GroupingStore({reader:t,data:{fixef:[{id:1,name:"Intercept",estimate:"",SE:"",assign:"0",factor:"Intercept"}]},sortInfo:{field:"assign",direction:"ASC"},groupField:"factor"}),columns:[{id:"name",header:"name",width:60,sortable:false,dataIndex:"name"},{header:"Estimate",align:"right",width:20,sortable:false,dataIndex:"estimate"},{header:"SE",align:"right",width:20,sortable:false,dataIndex:"SE"},{header:"t value",align:"right",width:20,sortable:false,dataIndex:"tvalue"},{header:"Predictor",width:20,hidden:true,sortable:false,dataIndex:"factor"}],view:new Ext.grid.GroupingView({forceFit:true,groupTextTpl:'{text} ({[values.rs.length]} {[values.rs.length > 1 ? "DF" : "DF"]})'}),tbar:[{iconCls:"folder-open",menu:N},"Fixed Effects","->",{iconCls:"icon-grid",text:"Cov Matrix",disabled:true,handler:function(){k("Fixed Effects Covariance Matrix",K().model.fixedCov.fields,K().model.fixedCov.data)}},{iconCls:"icon-grid",text:"Cor Matrix",disabled:true,handler:function(){k("Fixed Effects Correlation Matrix",K().model.fixedCor.fields,K().model.fixedCor.data)}}],frame:false,width:500,autoHeight:true,collapsible:true,disableSelection:true,animCollapse:true});O.predictors=new Array();O.predictors[0]="Intercept";O.on("render",function(){new Ext.dd.DropZone(O.getView().scroller,{getTargetFromEvent:function(P){return"fixedPanel"},ddGroup:"DragDrop",overClass:"nodeOverDragzone",onNodeDrop:c})});Ext.getCmp("cardLayout").add({id:"Model_"+m,bodyStyle:"background-color: #dfe8f6;",border:false,autoHeight:true,layout:"anchor",items:[O]});Ext.getCmp("cardLayout").getLayout().setActiveItem("Model_"+m);Ext.getCmp("currentModelPanel").setTitle("Model "+m);Ext.getCmp("modelList").getStore().loadData([[m,"..."]],true);K().thisModelNumber=m;K().fixef=O;K().model=new Object();K().targetGroups=new Object();K().totalRandomEffects=new Object();K().randomGroupCount=0;Ext.getCmp("modelList").getSelectionModel().selectRow(m-1);Ext.getCmp("modelList").getSelectionModel().on("rowselect",i);q({})}function i(O,P,N){Ext.getCmp("cardLayout").getLayout().setActiveItem(P+1);Ext.getCmp("currentModelPanel").setTitle("Model "+(P+1));q(K().model)}function A(P){K().fixef.getStore().loadData(P);K().fixef.getTopToolbar().get(3).enable();K().fixef.getTopToolbar().get(4).enable();if(P.anova){Ext.getCmp("modelList").anova=P.anova;Ext.getCmp("anovabutton").enable()}else{Ext.getCmp("modelList").anova=null;Ext.getCmp("anovabutton").disable()}var O=0;for(var N in K().targetGroups){K().targetGroups[N].getStore().loadData(P.randomCovMatrices[O]);K().targetGroups[N].getTopToolbar().get(3).enable();K().targetGroups[N].getTopToolbar().get(4).enable();K().targetGroups[N].getTopToolbar().get(5).enable();K().targetGroups[N].getTopToolbar().get(6).enable();K().targetGroups[N].getTopToolbar().get(5).randomGroupCount=O;K().targetGroups[N].getTopToolbar().get(6).randomGroupCount=O;O++}Ext.getCmp("modelList").getStore().getById(K().thisModelNumber).set("Model",P.formula);if(x){Ext.getCmp("reportWindow").destroy();x=null}q(P)}function H(){if(Ext.getCmp("dependent").validate()){a=Ext.getCmp("dependent").value;DVfamily=Ext.getCmp("family").value;reml=Ext.getCmp("reml").value;fixedIV=K().fixef.predictors;dataFile=Ext.getCmp("tree-panel").dataFile;randomIV=new Array();thisModelNumber=K().thisModelNumber;var O=0;for(var N in K().targetGroups){O++;if(K().targetGroups[N].predictors.length==0){alert("A Random Effects group '"+N.substring(3)+"' has no predictors in it! \n Add predictors or remove this group.");K().targetGroups[N].getEl().highlight("ff0000",{attr:"color",duration:1});return false}randomIV[randomIV.length]={group:N.substring(3),varName:N,predictors:K().targetGroups[N].predictors}}if(O==0){alert("Your model has no random effect terms!\n\nRight mouse-click a variable from the menu to add random effect groups.");return false}request={thisModelNumber:thisModelNumber,reml:reml,dependent:a,dataFile:dataFile,DVfamily:DVfamily,fixedIV:fixedIV,randomIV:randomIV};Ext.Ajax.request({timeout:60000,url:"../brew/lme-model",method:"POST",params:{lmeRequest:Ext.util.JSON.encode(request)},success:function(Q){try{result=Ext.decode(Q.responseText)}catch(P){alert("error in decoding json. ResponseText: "+Q.responseText+". Possibly server overload. Try again later.")}if(!result.success){alert("R Catched an error:\n\n"+result.error)}else{A(result.modelFit);K().model=result.modelFit;Ext.getCmp("reportbutton").enable()}},failure:function(P){alert("ERROR: "+P.responseText)}})}}function c(Q,N,P,O){if(O.node.leaf==true){w(O.node.id)}}function w(N){targetGrid=K().fixef;if(targetGrid.predictors.Contains(N)){alert("This predictor is already in the model!");return}else{targetGrid.getStore().loadData({fixef:[{id:N,name:N,factor:N}]},true);targetGrid.predictors.push(N)}e()}function o(Q,N,P,O){if(O.node.leaf){predictor=O.node.id;targetGrid=K().targetGroups[Q];if(K().totalRandomEffects[Q.substring(3)].Contains(predictor)){alert("This predictor is already in the model!")}else{targetGrid.getStore().loadData({variances:[{id:predictor,name:predictor,factor:predictor}]},true);targetGrid.predictors.push(predictor);K().totalRandomEffects[Q.substring(3)].push(predictor)}e()}}var B=new Ext.data.JsonStore({root:"children",idProperty:"id",fields:["id","text"]});var a=new Ext.form.ComboBox({allowBlank:false,triggerAction:"all",fieldLabel:"Dependent",forceSelection:true,mode:"local",id:"dependent",typeAhead:false,editable:false,listeners:{change:function(){e()}},width:150,blankText:"This field is required!",store:B,valueField:"id",displayField:"text"});var I=new Ext.form.ComboBox({triggerAction:"all",editable:false,id:"groupingVar",fieldLabel:"Grouping",forceSelection:true,mode:"local",store:B,typeAhead:false,emptyText:"Grouping",width:100,valueField:"id",displayField:"text"});var f={anchor:"100%",autoHeight:true,xtype:"fieldset",collapsible:true,frame:false,title:"General Properties",items:[a,{fieldLabel:"Family",value:"gaussian",triggerAction:"all",id:"family",mode:"local",typeahead:true,editable:false,xtype:"combo",width:150,store:["gaussian","binomial","Gamma","inverse.gaussian","poisson","quasi","quasibinomial","quasipoisson"],listeners:{change:function(){e();if(this.value=="gaussian"){Ext.getCmp("reml").setValue(true).enable()}else{Ext.getCmp("reml").setValue(false).disable()}}}}]};var y={anchor:"100%",autoHeight:true,xtype:"fieldset",collapsible:true,frame:false,title:"Options",collapsed:true,items:[{fieldLabel:"REML",value:true,triggerAction:"all",id:"reml",mode:"local",editable:false,xtype:"combo",width:150,store:[true,false],listeners:{change:function(){e()}}}]};var t=new Ext.data.JsonReader({root:"fixef",idProperty:"id",fields:[{name:"id"},{name:"name"},{name:"estimate"},{name:"SE"},{name:"assign"},{name:"tvalue"},{name:"factor"}]});var J=new Ext.data.JsonReader({root:"variances",idProperty:"id",fields:[{name:"id"},{name:"name"},{name:"variance"},{name:"sd"}]});function k(T,N,S){var P=new Array();for(var O=0;O<N.length;O++){P[O]={id:O,header:N[O],align:"right",dataIndex:N[O]}}var R=new Ext.grid.GridPanel({enableHdMenu:false,store:new Ext.data.ArrayStore({fields:N,data:S}),columns:P});width=N.length*100+50;if(width<250){width=250}if(width>800){width=800}height=S.length*25+60;if(height<120){height=120}if(height>500){height=500}var Q=new Ext.Window({title:T,width:width,height:height,layout:"fit",plain:true,bodyStyle:"padding:5px;",items:R});Q.show()}function G(O){K().remove(K().targetGroups[O]);K().targetGroups[O].destroy();predictorsToRemove=K().targetGroups[O].predictors;for(var N=0;N<predictorsToRemove.length;N++){K().totalRandomEffects[O.substring(3)].remove(predictorsToRemove[N])}delete K().targetGroups[O];e()}function s(O){O=Math.floor(Math.random()*800+100)+O;var N=new Ext.grid.GridPanel({enableHdMenu:false,bodyStyle:"margin-bottom:10px;",anchor:"100%",region:"center",store:new Ext.data.Store({reader:J}),columns:[{id:"Predictor",header:"Predictor",width:60,sortable:false,dataIndex:"name"},{header:"Variance",align:"right",width:20,sortable:false,dataIndex:"variance"},{header:"SD",align:"right",width:20,sortable:false,dataIndex:"sd"}],tbar:[{iconCls:"folder-open"},"Random: <b>"+O.substring(3)+"</b>","->",{iconCls:"collapse-all",text:"Effects",disabled:true,handler:function(){k("Random Effects: "+O.substring(3),K().model.ranef[O.substring(3)].fields,K().model.ranef[O.substring(3)].data)}},{iconCls:"pdf",text:"Dotplots",disabled:true,handler:function(){window.open("plots/."+K().model.ranef[O.substring(3)].plotfile+".pdf")}},{iconCls:"icon-grid",text:"Cov Matrix",disabled:true,randomGroupCount:K().randomGroupCount,handler:function(){k("Random Covariance Matrix: "+O.substring(3),K().model.randomCovMatrices[this.randomGroupCount].fields,K().model.randomCovMatrices[this.randomGroupCount].CovMatrix)}},{iconCls:"icon-grid",text:"Cor Matrix",disabled:true,randomGroupCount:K().randomGroupCount,handler:function(){k("Random Correlation Matrix: "+O.substring(3),K().model.randomCovMatrices[this.randomGroupCount].fields,K().model.randomCovMatrices[this.randomGroupCount].CorMatrix)}},{iconCls:"close",handler:function(){G(O)}}],viewConfig:{forceFit:true},frame:false,width:500,autoHeight:true,collapsible:true,disableSelection:true,animCollapse:true});N.predictors=new Array();N.number=K().randomGroupCount;K().randomGroupCount++;if(!K().totalRandomEffects[O.substring(3)]){K().totalRandomEffects[O.substring(3)]=new Array()}if(!K().totalRandomEffects[O.substring(3)].Contains("Intercept")){N.predictors.push("Intercept");N.getStore().loadData({variances:[{id:"Intercept",name:"Intercept"}]});K().totalRandomEffects[O.substring(3)].push("Intercept")}N.groupingVar=O;K().targetGroups[O]=N;K().add(N);K().doLayout();new Ext.dd.DropZone(N.getView().scroller,{getTargetFromEvent:function(P){return O},ddGroup:"DragDrop",overClass:"nodeOverDragzone",onNodeDrop:o})}function q(O){var N=new Ext.Template("<h1>Model Details:</h1>","<p>Formula: {formula}</p>","<p>REML: {REML}</p>","<p>Deviance: {Deviance} (DF:{DF})</p>","<p>AIC: {AIC}</p>","<p>BIC: {BIC}</p>","<p>Sigma: {Sigma}</p>");N.overwrite(Ext.getCmp("modelDetails").body,O)}var M=new Ext.FormPanel({id:"uploadPanel",border:true,margins:"3 3 0 3",fileUpload:true,bodyStyle:"padding: 5px 5px 5px 5px;",labelWidth:100,region:"north",height:35,items:{xtype:"fileuploadfield",fieldLabel:"Upload new data",buttonOnly:true,name:"datafile",timeout:60000,url:"../brew/lme-upload",waitMsg:"Uploading your data...",listeners:{fileselected:function(O,N){if(M.getForm().isValid()){M.getForm().submit({method:"post",url:"../brew/lme-upload",waitMsg:"Uploading data...",success:function(Q,P){rootNode=Ext.getCmp("tree-panel").getRootNode();while(rootNode.childNodes.length>0){rootNode.removeChild(rootNode.item(0))}Ext.getCmp("tree-panel").getRootNode().appendChild(P.result.variables);Ext.getCmp("dependent").getStore().loadData(P.result.variables[1]);Ext.getCmp("dependent").getStore().loadData(P.result.variables[0],true);Ext.getCmp("tree-panel").dataFile=P.result.dataFile;Ext.getCmp("tree-panel").varInfo=P.result.varInfo;Ext.getCmp("uploadPanel").hide();Ext.getCmp("dataPanel").doLayout()},failure:function(Q,P){alert("R catched an error: "+P.result.error)}})}}}}});var D=new Ext.tree.TreePanel({selModel:new Ext.tree.MultiSelectionModel(),border:true,margins:"3 3 0 3",singleExpand:false,bodyStyle:"padding: 5px 5px 5px 5px;",id:"tree-panel",region:"center",iconCls:"downArrow",autoScroll:true,animate:true,enableDrag:true,dragConfig:{ddGroup:"DragDrop"},rootVisible:false,lines:false,useArrows:true,root:new Ext.tree.AsyncTreeNode({id:"root1"})});D.on("contextmenu",v);var r;D.on("click",function(P){var O=this.selModel.selNode||{};if(P.leaf&&P.id!=O.id&&P.id!="Intercept"){var N=Ext.getCmp("details-panel").body;N.update("").setStyle("background","#fff");myP=document.createElement("p");myP.className="details-info";myPre=document.createElement("pre");myP.appendChild(myPre);myCode=document.createElement("code");myPre.appendChild(myCode);myTextNode=document.createTextNode(Ext.getCmp("tree-panel").varInfo[P.id].remove("NA").join("\r\n"));myCode.appendChild(myTextNode);r=N.createChild();r.appendChild(myP);r.hide().slideIn("l",{stopFx:true,duration:0.2})}});var p={region:"south",border:true,margins:"0 3 3 3",id:"details-panel",titleCollapse:true,height:165,collapsible:true,split:true,bodyStyle:"padding-bottom:15px;background:#eee;",autoScroll:true,html:'<p class="details-info">Variable details will display here.</p>'};var z={id:"dataPanel",region:"west",layout:"border",border:true,title:"Datapanel",margins:"5 0 5 5",width:200,items:[M,D,p]};var g=new Ext.Panel({bodyStyle:"background-color: #dfe8f6;",anchor:"100%",layout:"card",activeItem:0,id:"cardLayout",border:false,items:[{bodyStyle:"background-color: #dfe8f6;",border:false,autoHeight:true,layout:"anchor",items:[]}]});var l={id:"currentModelPanel",region:"center",layout:"anchor",margins:"5 0 5 5",bodyStyle:"background-color: #dfe8f6; padding:3px 20px 3px 3px; overflow-x: hidden; overflow-y: scroll;",border:true,title:"Current model",items:[f,y,g],fbar:[{iconCls:"fit",text:"Fit Model",handler:function(){H()}},{iconCls:"reset",text:"Reset",handler:function(){L()}}]};var j=new Ext.grid.GridPanel({id:"modelList",mode:"local",store:new Ext.data.ArrayStore({fields:["id","Model"],data:[],idIndex:0}),columns:[new Ext.grid.RowNumberer(),{header:"Model",width:120,dataIndex:"Model",sortable:true}],sm:new Ext.grid.RowSelectionModel({singleSelect:true}),viewConfig:{forceFit:true},height:200,border:true,margins:"3 3 0 3",hideHeaders:true,autoScroll:true,region:"center",fbar:[{iconCls:"newModel",text:"Add Model",handler:function(){b()}},{disabled:true,iconCls:"book",id:"anovabutton",text:"Anova",handler:function(){E()}}]});var x;var F;var h={margins:"3 3 3 3",id:"modelDetails",layout:"fit",html:"<h1> Model Details </h1>",region:"south",height:200,bodyStyle:{background:"#ffffff",padding:"7px"},border:true,buttons:[{text:"Analysis Report",iconCls:"pdf",disabled:true,id:"reportbutton",handler:function(){if(!x){x=new Ext.Window({closeAction:"hide",id:"reportWindow",width:150,height:160,title:"Analysis Report",autoLoad:{listeners:{beforerequest:function(){}},url:"../brew/lme-report",timeout:60000,method:"POST",disableCaching:true,params:{reportRequest:Ext.util.JSON.encode({dataFile:Ext.getCmp("tree-panel").dataFile})}}})}x.show()}},{text:"Cite",iconCls:"bib",width:50,handler:function(){C()}}]};var u={region:"east",layout:"border",margins:"5 5 5 5",width:250,border:true,title:"Model Selection",items:[j,h]};new Ext.Viewport({id:"viewport",bodyStyle:"background: none",layout:"border",cls:"viewport",title:"Ext Layout Browser",items:[{xtype:"box",region:"north",applyTo:"header",height:30},z,l,u],renderTo:Ext.getBody()});b();new Ext.ToolTip({target:"uploadPanel",dismissDelay:0,trackMouse:true,html:"<h1>Upload Data</h1><p>Upload SPSS (*.sav), CSV, or Tab Delimited data.</p> <p> For csv/tabbed data, the first row should contain headers.</p>"})});Array.prototype.Contains=function(a){if(this.indexOf(a)>-1){return true}return false};